<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ëˆ—ì…ˆ 1ë‹¨ê³„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Jua (Cute Korean Font) -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <!-- html2canvas for Image Saving -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrolling on mobile during game */
        }

        .app-container {
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* New Pastel Palette: Cream Yellow, Soft Blue, Pale Pink */
        .bg-pastel-cream { background-color: #FFF9C4; } /* Start Screen */
        .bg-pastel-blue-soft { background-color: #B3E5FC; } /* Game Header */
        .bg-pastel-pink-pale { background-color: #F8BBD0; } /* Result Screen */
        
        .text-pastel-dark { color: #546E7A; }

        .btn-push {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-push:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Input styling */
        input:focus {
            outline: none;
            border-color: #B3E5FC;
            box-shadow: 0 0 0 3px rgba(179, 229, 252, 0.4);
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Mobile adaptation for screens smaller than 400px */
        @media (max-width: 420px) {
            .app-container {
                width: 95vw;
                height: 80vh; /* Adjusted for mobile vertical space */
                max-width: 400px;
                max-height: 600px;
            }
        }
    </style>
</head>
<body>

    <!-- Fullscreen Toggle Button -->
    <button onclick="toggleFullScreen()" class="fixed top-4 right-4 z-50 text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-gray-800" title="ì „ì²´í™”ë©´">
        <i data-lucide="expand" class="w-8 h-8"></i>
    </button>

    <!-- Main App Container -->
    <div id="app" class="app-container border-4 border-white">
        
        <!-- Screen 1: Start -->
        <div id="start-screen" class="w-full h-full flex flex-col items-center justify-center bg-pastel-cream p-6 text-center animate-pop">
            <div class="mb-8 text-pastel-dark">
                <i data-lucide="divide-circle" class="w-20 h-20 mx-auto mb-4 text-yellow-600"></i>
                <h1 class="text-4xl mb-2">ë‚˜ëˆ—ì…ˆ 1ë‹¨ê³„</h1>
                <h2 class="text-2xl text-yellow-700">ë„ì „! í€´ì¦ˆ 20</h2>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm w-full max-w-[320px]">
                <label class="block text-gray-500 mb-2 text-lg">í•™ìƒ ì´ë¦„</label>
                <input type="text" id="username-input" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 text-center text-xl mb-4" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ìš”">
                <button onclick="startGame()" class="btn-push w-full bg-pastel-blue-soft text-gray-700 py-3 rounded-xl text-xl shadow-md border-b-4 border-blue-200 font-bold">
                    ì‹œì‘í•˜ê¸°!
                </button>
            </div>
        </div>

        <!-- Screen 2: Game -->
        <div id="game-screen" class="w-full h-full hidden flex-col bg-white relative">
            <!-- Header: Timer & Progress -->
            <div class="flex justify-between items-center p-4 bg-pastel-blue-soft text-gray-700">
                <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                    <!-- Initial display 07:00 -->
                    <span id="timer-display" class="text-xl font-bold">07:00</span>
                </div>
                <div class="text-lg">
                    <span id="current-q">1</span> / 20
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full h-2 bg-gray-100">
                <div id="progress-bar" class="h-full bg-blue-300 transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Question Area -->
            <div class="flex-1 flex flex-col items-center justify-center p-4 animate-pop" id="question-container">
                <div class="mb-2 text-gray-400 text-sm font-bold" id="question-type-label">ê°ê´€ì‹ ë¬¸ì œ</div>
                
                <!-- Math Question Format -->
                <div id="math-q" class="text-5xl font-bold text-gray-700 mb-8 flex gap-4 items-center">
                    <span id="factor-a">125</span>
                    <span class="text-blue-400">Ã·</span>
                    <span id="factor-b">5</span>
                    <span>=</span>
                    <span class="w-24 h-20 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 text-3xl">?</span>
                </div>

                <!-- Input Area: Multiple Choice -->
                <div id="choice-area" class="grid grid-cols-2 gap-3 w-full max-w-[320px]">
                    <!-- Buttons generated by JS -->
                </div>

                <!-- Input Area: Direct Input with Keypad -->
                <div id="input-area" class="hidden flex-col items-center w-full">
                    <!-- Readonly Input for Display -->
                    <input type="text" id="direct-answer" class="w-40 bg-gray-50 border-4 border-blue-200 rounded-xl px-2 py-2 text-center text-3xl mb-4 text-blue-500 font-bold" placeholder="?" readonly>
                    
                    <!-- Numeric Keypad -->
                    <div class="grid grid-cols-3 gap-2 w-full max-w-[260px]">
                        <button onclick="keypadInput(1)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">1</button>
                        <button onclick="keypadInput(2)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">2</button>
                        <button onclick="keypadInput(3)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">3</button>
                        <button onclick="keypadInput(4)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">4</button>
                        <button onclick="keypadInput(5)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">5</button>
                        <button onclick="keypadInput(6)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">6</button>
                        <button onclick="keypadInput(7)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">7</button>
                        <button onclick="keypadInput(8)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">8</button>
                        <button onclick="keypadInput(9)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">9</button>
                        <button onclick="keypadClear()" class="btn-push bg-red-50 border-2 border-red-100 rounded-lg py-3 text-xl font-bold text-red-400 shadow-sm hover:bg-red-100">C</button>
                        <button onclick="keypadInput(0)" class="btn-push bg-white border-2 border-gray-100 rounded-lg py-3 text-xl font-bold text-gray-600 shadow-sm hover:bg-gray-50">0</button>
                        <button onclick="checkDirectAnswer()" class="btn-push bg-blue-400 border-b-4 border-blue-500 rounded-lg py-3 text-xl font-bold text-white shadow-md active:border-b-0 active:mt-1">í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 3: Result -->
        <div id="result-screen" class="w-full h-full hidden flex-col items-center justify-center bg-pastel-pink-pale p-4">
            
            <!-- Result Card (To be saved as image) -->
            <div id="result-card" class="bg-white w-full max-w-[340px] rounded-2xl p-6 shadow-lg flex flex-col items-center text-center border-2 border-pink-100 relative">
                
                <!-- Decoration -->
                <div class="absolute -top-6 bg-yellow-200 rounded-full p-3 border-4 border-white shadow-sm">
                    <i data-lucide="trophy" class="w-8 h-8 text-yellow-600"></i>
                </div>

                <h2 class="text-2xl font-bold text-gray-700 mt-6 mb-1">í•™ìŠµ ê²°ê³¼</h2>
                
                <!-- App Title -->
                <p class="text-sm text-pink-400 font-bold mb-2">ë‚˜ëˆ—ì…ˆ 1ë‹¨ê³„ : ë„ì „! í€´ì¦ˆ 20</p>

                <div class="w-full border-b border-gray-100 my-2"></div>
                
                <div class="flex flex-col gap-2 w-full text-left bg-gray-50 p-4 rounded-xl mb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-500">ì´ë¦„</span>
                        <span id="result-name" class="font-bold text-gray-700 text-lg">ê¹€í•™ìƒ</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">ì ìˆ˜</span>
                        <span class="font-bold text-pink-500 text-lg"><span id="result-score">0</span> / 100ì </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">ê±¸ë¦° ì‹œê°„</span>
                        <span id="result-time" class="font-bold text-blue-500">03:20</span>
                    </div>
                    <div class="flex justify-between text-sm mt-2 pt-2 border-t border-gray-200">
                        <span class="text-gray-400">ë‚ ì§œ</span>
                        <span id="result-date" class="text-gray-400">2023.00.00 00:00</span>
                    </div>
                </div>

                <p id="feedback-msg" class="text-lg text-gray-600 font-bold mb-1">ì°¸ ì˜í–ˆì–´ìš”! ğŸ‰</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6 w-full max-w-[340px]">
                <button onclick="downloadImage()" class="btn-push flex-1 bg-white text-gray-600 py-3 rounded-xl border-2 border-gray-200 font-bold flex justify-center gap-2 items-center">
                    <i data-lucide="image-down" class="w-5 h-5"></i> ì €ì¥í•˜ê¸°
                </button>
                <button onclick="resetGame()" class="btn-push flex-1 bg-pink-400 text-white py-3 rounded-xl shadow-md border-b-4 border-pink-500 font-bold flex justify-center gap-2 items-center">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i> ë‹¤ì‹œí•˜ê¸°
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- Game State & Data ---
        const TOTAL_QUESTIONS = 20;
        const TIME_LIMIT = 420; // 7 minutes (420 seconds)
        
        let state = {
            username: "",
            score: 0,
            currentQIndex: 0,
            timeLeft: TIME_LIMIT,
            timerId: null,
            startTime: null,
            endTime: null,
            questions: [] // Array of {type, qText, a, b, answer, options}
        };

        // --- Initialization ---
        lucide.createIcons();

        // --- Core Logic ---

        // Fullscreen Toggle
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Add Enter key support for username input
        document.getElementById('username-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                startGame();
            }
        });

        function startGame() {
            const nameInput = document.getElementById('username-input');
            const name = nameInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            state.username = name;
            state.score = 0;
            state.currentQIndex = 0;
            state.timeLeft = TIME_LIMIT;
            state.startTime = new Date();
            
            generateQuestions();
            
            // UI Switch
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            // Start Timer & Render
            renderQuestion();
            startTimer();
        }

        function generateQuestions() {
            state.questions = [];

            // 1. Multiple Choice (10 questions)
            for (let i = 0; i < 10; i++) {
                state.questions.push(generateMathProblem('choice'));
            }

            // 2. Direct Input (10 questions)
            for (let i = 0; i < 10; i++) {
                state.questions.push(generateMathProblem('input'));
            }
        }

        function generateMathProblem(type) {
            // Difficulty: 3-digit divided by 1-digit (No remainder)
            
            // 1. Generate Divisor (b): 2 to 9
            const divisor = Math.floor(Math.random() * 8) + 2; 

            // 2. Generate Quotient (answer): 
            // We want dividend (a) to be 3 digits (100 ~ 999).
            // Since a = b * quotient, we need quotient such that 100 <= b * quotient <= 999.
            // So, ceil(100/b) <= quotient <= floor(999/b).
            
            const minQuotient = Math.ceil(100 / divisor);
            const maxQuotient = Math.floor(999 / divisor);
            
            const quotient = Math.floor(Math.random() * (maxQuotient - minQuotient + 1)) + minQuotient;
            
            // 3. Calculate Dividend (a)
            const dividend = divisor * quotient;

            return {
                type: type,
                a: dividend,
                b: divisor,
                answer: quotient,
                options: type === 'choice' ? generateOptions(quotient) : null
            };
        }

        function generateOptions(correctAnswer) {
            const opts = new Set([correctAnswer]);
            while (opts.size < 4) {
                // Generate wrong answers close to real one
                let offset = Math.floor(Math.random() * 20) - 10; // -10 to +10 range
                let wrong = correctAnswer + offset;
                if (wrong > 0 && wrong !== correctAnswer) {
                    opts.add(wrong);
                }
            }
            return Array.from(opts).sort(() => 0.5 - Math.random());
        }

        function startTimer() {
            updateTimerDisplay();
            state.timerId = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    finishGame(true); // Time out
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
            
            if (state.timeLeft < 30) {
                document.getElementById('timer-display').classList.add('text-red-600');
            } else {
                document.getElementById('timer-display').classList.remove('text-red-600');
            }
        }

        // --- Rendering & Interaction ---

        function renderQuestion() {
            const q = state.questions[state.currentQIndex];
            const container = document.getElementById('question-container');
            
            // Re-trigger animation
            container.classList.remove('animate-pop');
            void container.offsetWidth; // Trigger reflow
            container.classList.add('animate-pop');

            // Update Progress
            document.getElementById('current-q').innerText = state.currentQIndex + 1;
            const progressPct = ((state.currentQIndex) / TOTAL_QUESTIONS) * 100;
            document.getElementById('progress-bar').style.width = `${progressPct}%`;

            // Reset UI Visibility
            document.getElementById('math-q').classList.add('hidden');
            document.getElementById('choice-area').classList.add('hidden');
            document.getElementById('input-area').classList.add('hidden');
            
            // Clear inputs
            document.getElementById('direct-answer').value = '';

            // Labels
            const label = document.getElementById('question-type-label');
            if (q.type === 'choice') {
                label.innerText = "ê°ê´€ì‹ ë¬¸ì œ (ì•Œë§ì€ ë‹µì„ ê³¨ë¼ìš”)";
            } else {
                label.innerText = "ì£¼ê´€ì‹ ë¬¸ì œ (ì •ë‹µì„ ì…ë ¥í•´ìš”)";
            } 

            // Render Math Problem (Division)
            const mq = document.getElementById('math-q');
            document.getElementById('factor-a').innerText = q.a; // Dividend
            document.getElementById('factor-b').innerText = q.b; // Divisor
            mq.classList.remove('hidden');
            mq.classList.add('flex');

            if (q.type === 'choice') {
                renderChoices(q.options);
            } else {
                const ia = document.getElementById('input-area');
                ia.classList.remove('hidden');
                ia.classList.add('flex');
                // No focus needed for keypad
            }
        }

        function renderChoices(options) {
            const area = document.getElementById('choice-area');
            area.innerHTML = '';
            area.classList.remove('hidden');
            area.classList.add('grid');

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-push bg-white border-2 border-blue-200 text-gray-700 py-4 rounded-xl text-2xl font-bold shadow-sm hover:bg-blue-50 hover:border-blue-300';
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(opt);
                area.appendChild(btn);
            });
        }

        // --- Handling Answers (Keypad Logic) ---

        function keypadInput(num) {
            const input = document.getElementById('direct-answer');
            if (input.value.length < 4) { // Limit length
                input.value += num;
            }
        }

        function keypadClear() {
            document.getElementById('direct-answer').value = '';
        }

        function checkDirectAnswer() {
            const input = document.getElementById('direct-answer');
            const val = parseInt(input.value);
            if (isNaN(val)) return; // Do nothing if empty
            submitAnswer(val);
        }

        function submitAnswer(userAnswer) {
            const currentQ = state.questions[state.currentQIndex];
            
            if (userAnswer === currentQ.answer) {
                state.score += 5;
            }

            state.currentQIndex++;

            if (state.currentQIndex >= TOTAL_QUESTIONS) {
                finishGame(false);
            } else {
                renderQuestion();
            }
        }

        function finishGame(isTimeout) {
            clearInterval(state.timerId);
            state.endTime = new Date();
            
            // Calculate elapsed time
            const elapsedSeconds = TIME_LIMIT - state.timeLeft;
            const em = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const es = (elapsedSeconds % 60).toString().padStart(2, '0');

            // Format Date
            const now = new Date();
            const dateStr = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

            // Populate Result Screen
            document.getElementById('result-name').innerText = state.username;
            document.getElementById('result-score').innerText = state.score;
            document.getElementById('result-time').innerText = isTimeout ? "ì‹œê°„ ì´ˆê³¼" : `${em}:${es}`;
            document.getElementById('result-date').innerText = dateStr;

            // Feedback Message
            const msg = document.getElementById('feedback-msg');
            if (state.score === 100) msg.innerText = "ì™„ë²½í•´ìš”! ì²œì¬! ğŸ†";
            else if (state.score >= 80) msg.innerText = "ì˜í–ˆì–´ìš”! ğŸ‘";
            else if (state.score >= 60) msg.innerText = "ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ìš”. ğŸ‘";
            else msg.innerText = "ì—°ìŠµì´ ë§ì´ í•„ìš”í•´ìš”.  ğŸŒ±";

            // Switch Screens
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('flex');
        }

        function resetGame() {
            document.getElementById('username-input').value = '';
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('flex');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('start-screen').classList.add('flex');
        }

        function downloadImage() {
            const element = document.getElementById("result-card");
            
            // Generate filename: yymmdd-hhmmss.jpg
            const now = new Date();
            const yy = now.getFullYear().toString().slice(-2);
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const hh = now.getHours().toString().padStart(2, '0');
            const min = now.getMinutes().toString().padStart(2, '0');
            const ss = now.getSeconds().toString().padStart(2, '0');
            
            const filename = `${yy}${mm}${dd}-${hh}${min}${ss}.jpg`;

            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement("a");
                link.download = filename;
                // Save as JPEG
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>